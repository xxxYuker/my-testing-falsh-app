{% extends "base.html" %}

{% block title %}è‡ªåŠ¨åŒ–å·¥åŠ{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.2.0/github-markdown-light.min.css">

<style>
    /* ä¸“é—¨ç”¨æ¥æ”¾å‘¨æŠ¥çš„ç›’å­ */
    .report-box {
        background: #fff;
        border: 1px solid #e1e4e8;
        border-radius: 6px;
        padding: 30px;
        margin-top: 20px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    }
</style>

<div class="text-center mb-5">
    <h1 class="display-5 fw-bold">âš¡ è‡ªåŠ¨åŒ–å·¥åŠ</h1>
    <p class="lead text-muted">AI èµ‹èƒ½ï¼Œæ•ˆç‡å€å¢ã€‚</p>
</div>

{% if report_content %}
    <div class="row justify-content-center mb-5">
        <div class="col-md-10">
            
            <div class="d-flex align-items-center mb-3 text-success">
                <i class="bi bi-check-circle-fill fs-3 me-2"></i>
                <h4 class="mb-0">å‘¨æŠ¥å·²ç”Ÿæˆ</h4>
            </div>
            
            <div class="report-box markdown-body bg-white p-5 rounded shadow-sm border">
                
                <div id="raw-content" style="display:none;">{{ report_content }}</div>
                
                <div id="rendered-content"></div>
                
            </div>
            
            <div class="text-end mt-2">
                <button class="btn btn-outline-secondary btn-sm" onclick="navigator.clipboard.writeText(document.getElementById('raw-content').innerText); alert('å·²å¤åˆ¶ï¼')">
                    <i class="bi bi-clipboard"></i> å¤åˆ¶å†…å®¹
                </button>
            </div>
            
        </div>
    </div>
{% endif %}

<div class="row g-4 justify-content-center mt-3">
    <div class="col-md-5">
        <div class="card h-100 text-center p-4 hover-shadow border-primary">
            <div class="card-body">
                <i class="bi bi-file-earmark-spreadsheet text-primary display-1 mb-3"></i>
                <h4 class="card-title">AI å‘¨æŠ¥åŠ©æ‰‹</h4>
                <p class="card-text text-muted">è¾“å…¥ç¢ç‰‡å·¥ä½œï¼Œç”Ÿæˆå®Œç¾å‘¨æŠ¥ã€‚</p>
                <button type="button" class="btn btn-primary mt-3 px-4" data-bs-toggle="modal" data-bs-target="#reportModal">
                    âœ¨ ç«‹å³ç”Ÿæˆ
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="reportModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ğŸ“ ç”Ÿæˆæœ¬å‘¨å‘¨æŠ¥</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="/generate_report" method="POST">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">æœ¬å‘¨å·¥ä½œè¦ç‚¹</label>
                        <textarea name="work_items" class="form-control" rows="6" placeholder="ä¾‹å¦‚ï¼š
1. å®Œæˆäº† N8N éƒ¨ç½²
2. ä¿®å¤äº† HTTPS è¯ä¹¦é—®é¢˜..." required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary" onclick="this.innerHTML='â³ ç”Ÿæˆä¸­...';">ğŸ¤– å¼€å§‹ç”Ÿæˆ</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // ç­‰é¡µé¢åŠ è½½å®Œ
    document.addEventListener("DOMContentLoaded", function() {
        // æ‹¿åˆ°åŸå§‹æ–‡æœ¬
        var rawText = document.getElementById('raw-content');
        if (rawText) {
            var text = rawText.innerText;
            // å‰”é™¤æ‰ Flask å¯èƒ½åŠ åœ¨å‰é¢çš„ "âœ… å‘¨æŠ¥ç”ŸæˆæˆåŠŸï¼å†…å®¹å¦‚ä¸‹ï¼š" è¿™ç±»æç¤ºè¯ï¼ˆå¦‚æœåœ¨ app.py é‡ŒåŠ äº†çš„è¯ï¼‰
            // å¦‚æœ app.py é‡Œç›´æ¥ flash(response.text)ï¼Œé‚£å°±ä¸ç”¨å‰”é™¤
            
            // ä½¿ç”¨ marked åº“æŠŠ Markdown å˜æˆ HTML
            document.getElementById('rendered-content').innerHTML = marked.parse(text);
        }
    });
</script>

{% endblock %}